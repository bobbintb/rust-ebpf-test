# Project Agents.md Guide for AI agents

This Agents.md file provides comprehensive guidance for AI agents working with this codebase.

## Project Structure 

- `/dirt`: Rust eBPF user-space code
  - `/src`: Rust eBPF user-space source code
    - `/main.rs`: Main Rust eBPF user-space code
  - `/build.rs`: Build file for user-space code
  - `/Cargo.toml`: Rust dependencies for eBPF user-space code
- `/dirt-common`: Rust eBPF code shared between the kernel-space and user-space code
  - `/src`: Rust eBPF source code shared between the kernel-space and user-space
    - `/lib.rs`: Library target source code shared between the kernel-space and user-space
  - `/build.rs`: Build file for code shared between the kernel-space and user-space
  - `/Cargo.toml`: Rust dependencies for eBPF code shared between the kernel-space and user-space
- `/dirt-ebpf`: Rust eBPF kernel-space code
  - `/src`: Rust eBPF kernel-space source code
    - `/lib.rs`: Library target source code for kernel-space
    - `/main.rs`: Main Rust eBPF kernel-space code
    - `/vmlinux.rs`: Rust eBPF kernel bindings (This file is autogenerated and should NOT be modified)
  - `/build.rs`: Build file for kernel-space code
  - `/Cargo.toml`: Rust dependencies for eBPF kernel-space code

## Environment setup

The following script will set up the build envrionment on Ubuntu. If the agent has a snapshot available then this script was likely already ran and captured in the snapshot. In such case, running it again should not be needed but can be used for reference.

```bash
rustup toolchain install nightly --component rust-src
cargo install bpf-linker
cargo install bindgen-cli
cargo install --git https://github.com/aya-rs/aya -- aya-tool
sudo apt update -y
sudo apt install build-essential llvm-14 clang-14 libclang-14-dev cmake libssl-dev pkg-config python3 git -y
wget $(curl -s https://archive.ubuntu.com/ubuntu/pool/main/l/linux/ | grep -oP 'bpftool_[^"]+_amd64.deb' | sort -V | tail -1 | awk '{print "https://archive.ubuntu.com/ubuntu/pool/main/l/linux/" $1}')
sudo apt install ./bpftool* -y
```

## Rust modules and dependencies

This program uses `aya` for working with ebpf. Below are the latest versions of the aya modules the agent may need for this program. Take careful note of the names of these modules as these are the only `aya` modules that should be needed and are named correctly. Historically, agents have tended to try to import non-existent modules with similar names or non-existent versions and for some unknown reason, have been unable to proceed or resolve the issue because they will not check the Rust cargo repository for the correct names and versions. For this reason, I have included this information to clarify the names and versions of any `aya` modules that may be needed. The agent should not, under any circumstance, try to use an `aya` module that is not listed here because these are all the available `aya` modules. One frequent example is `aya-bpf`. The module `aya-bpf` does not exist and the proper module is `aya-ebpf`. If the agent believes a certain `aya` module is needed that is not in this list, the agent is wrong and should refer to this list for clarification.

```
aya = "0.13.1"
aya-ebpf = "0.1.1"
aya-ebpf-macros = "0.1.1"
aya-ebpf-bindings = "0.1.1"
aya-ebpf-cty = "0.2.2"
aya-log = "0.2.1"
aya-log-ebpf = "0.1.1"
aya-log-ebpf-macros = "0.1.0"
aya-log-parser = "0.1.13"
aya-log-common = "0.1.15"
aya-obj = "0.2.1"
aya-build = "0.1.2"
```

## Buildng and testing

The build environment has been thoroughly tested and is correct for this project. The agent should not make any changes to the build environment after running the build script. If the agent thinks there is an issue with the environment, the agent is wrong and should not under any circumstances make any changes to the environment but ask for guidance instead.
Agents should only try and build from the root project folder and not the individual program folders. After cloning, enter the root project folder with the following command:

```bash
cd rust-ebpf-test/
```

Agents should use the following command to build the project:

```bash
cargo +nightly build
```

Because this is an eBPF CO-RE program, both eBPF and BTF must be enabled in the kernel. Agents may not be able to run and test the program once it has been built if the kernel in their build environment was not compile with these configuration options. As such, the project includes a pregenerated `vmlinux.rs` file that is needed for BTF. This file is dependent on the kernel of the build environment. The included `vmlinux.rs` is for kernel 6.12.24. If the agent's build environment does have eBPF and BTF enabled then and only then should the `vmlinux.rs` file removed and the build environment will regenerate it for that environment. After completing an assigned task, agents should build the project from the project root folder using the build command previously specified. If the build fails, agents should attempt to address build errors and retry building until the project builds successfully.
